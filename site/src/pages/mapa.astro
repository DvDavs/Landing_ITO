---
import BaseLayout from '../layouts/BaseLayout.astro';
import Icon from '../components/Icon.astro';

const locations = [
  {
    id: 'direccion',
    name: 'Dirección',
    icon: 'mdi:office-building',
    description: 'Edificio principal y oficinas administrativas',
    images: {
      mapa: '/images/direccion/mapa.png',
      satelital: '/images/direccion/satelital.png'
    },
    routeUrl: 'https://maps.app.goo.gl/aCLau7wuqve9dmFN8'
  },
  {
    id: 'gimnasio',
    name: 'Gimnasio Auditorio',
    icon: 'mdi:dumbbell',
    description: 'Instalaciones deportivas y eventos',
    images: {
      mapa: '/images/gym/mapa.png',
      satelital: '/images/gym/satelital.png'
    },
    routeUrl: 'https://maps.app.goo.gl/cvJitdrjZtEog2XEA'
  },
  {
    id: 'centro-informacion',
    name: 'Centro de Información',
    icon: 'mdi:information-outline',
    description: 'Punto de atención y orientación',
    images: {
      mapa: '/images/ci/mapa.png',
      satelital: '/images/ci/satelital.png'
    },
    routeUrl: 'https://maps.app.goo.gl/6nH8WMVNipxKa3ZA6'
  },
  {
    id: 'estadio',
    name: 'Estadio',
    icon: 'mdi:stadium',
    description: 'Instalaciones deportivas exteriores',
    images: {
      mapa: '/images/Estadio/mapa.png',
      satelital: '/images/Estadio/satelital.png'
    },
    routeUrl: 'https://www.google.com/maps/dir//Estadio+Tecnol%C3%B3gico+de+Oaxaca'
  }
];
---

<BaseLayout 
  title="Mapa del Instituto Tecnológico de Oaxaca - XXXI Encuentro Nacional" 
  description="Mapa interactivo y ubicación de puntos clave en la sede del evento."
>
  <section class="page-hero">
    <div class="container">
      <div class="page-hero-content">
        <span class="page-badge">Ubicación</span>
        <h1 class="page-title">Mapa de la Sede</h1>
        <p class="page-subtitle">
          Selecciona un punto de interés para verlo en el mapa
        </p>
      </div>
    </div>
  </section>

  <section class="map-section">
    <div class="container layout-grid">
      
      <aside class="locations-sidebar" role="complementary" aria-label="Puntos de interés">
        <h2>Puntos de Interés</h2>
        <div class="locations-list" role="list">
          {locations.map((loc, index) => (
            <article 
              class={`location-card ${index === 0 ? 'active' : ''}`} 
              data-id={loc.id} 
              data-mapa={loc.images.mapa}
              data-satelital={loc.images.satelital}
              role="listitem"
            >
              <button 
                class="card-content" 
                type="button" 
                aria-label={`Ver ${loc.name} en el mapa`}
                aria-pressed={index === 0 ? 'true' : 'false'}
              >
                <div class="card-header">
                  <Icon icon={loc.icon} class="location-icon" width="1.25rem" height="1.25rem" aria-hidden="true" />
                  <h3>{loc.name}</h3>
                </div>
                <p class="location-description">{loc.description}</p>
              </button>
              <div class="card-actions">
                <a 
                  href={loc.routeUrl} 
                  target="_blank" 
                  rel="noopener noreferrer" 
                  class="route-btn" 
                  aria-label={`Cómo llegar a ${loc.name} con Google Maps`}
                >
                  <Icon icon="mdi:map-marker" class="route-icon" width="1rem" height="1rem" aria-hidden="true" />
                  Ver en Google Maps
                </a>
              </div>
            </article>
          ))}
        </div>
      </aside>

      <div class="map-container" role="region" aria-label="Vista del mapa">
        <div class="map-controls" role="toolbar" aria-label="Controles del mapa">
          <button 
            class="mode-btn" 
            data-mode="mapa" 
            type="button"
            aria-pressed="false"
            aria-label="Ver mapa estilo plano"
          >
            <Icon icon="mdi:map" class="mode-icon" width="1.1rem" height="1.1rem" aria-hidden="true" />
            Mapa
          </button>
          <button 
            class="mode-btn active" 
            data-mode="satelital" 
            type="button"
            aria-pressed="true"
            aria-label="Ver mapa satelital"
          >
            <Icon icon="mdi:satellite-variant" class="mode-icon" width="1.1rem" height="1.1rem" aria-hidden="true" />
            Satelital
          </button>
        </div>
        <div class="image-wrapper">
          <img 
            id="main-map-image" 
            src={locations[0].images.satelital} 
            alt="Vista satelital de Dirección"
            class="map-image"
            width="800"
            height="600"
            loading="eager"
            decoding="async"
          />
          <link rel="preload" as="image" href={locations[0].images.mapa} />
          <link rel="preload" as="image" href={locations[0].images.satelital} />
        </div>
      </div>

    </div>
  </section>
</BaseLayout>

<style>
  .page-hero {
    background: linear-gradient(135deg, rgba(27, 57, 106, 0.5) 0%, rgba(93, 133, 166, 0.5) 100%), url('/images/oaxaca/food-3154214_1280.webp');
    background-size: cover;
    background-position: bottom;
    padding: 4rem 0 3rem;
    color: white;
    position: relative;
  }

  .page-hero-content {
    position: relative;
    text-align: center;
    max-width: 800px;
    margin: 0 auto;
  }

  .page-badge {
    display: inline-block;
    padding: 0.5rem 1.5rem;
    background: rgba(255, 255, 255, 0.2);
    backdrop-filter: blur(10px);
    border-radius: var(--radius-full);
    font-weight: 600;
    font-size: 0.9375rem;
    margin-bottom: var(--spacing-md);
    border: 1px solid rgba(255, 255, 255, 0.3);
  }

  .page-title {
    color: white;
    margin-bottom: var(--spacing-sm);
    font-size: clamp(1.75rem, 5vw, 2.5rem);
    font-weight: 700;
  }

  .page-subtitle {
    font-size: 1.25rem;
    color: rgba(255, 255, 255, 0.9);
    font-weight: 300;
  }

  .map-section {
    padding: 3rem 0;
    background-color: #f4f6f9;
    min-height: 70vh;
  }

  .container {
    max-width: 1200px;
    margin: 0 auto;
    padding: 0 1.5rem;
  }

  .layout-grid {
    display: grid;
    grid-template-columns: minmax(300px, 380px) 1fr;
    gap: 2rem;
    align-items: start;
  }

  .locations-sidebar {
    background: #fff;
    border-radius: 12px;
    padding: 1.25rem;
    box-shadow: 0 2px 8px rgba(0,0,0,.08);
    max-height: 600px;
    overflow-y: auto;
    position: sticky;
    top: 20px;
    will-change: scroll-position;
  }

  .locations-sidebar h2 {
    color: #1B396A;
    margin: 0 0 1.25rem;
    padding-bottom: .75rem;
    border-bottom: 2px solid #f0f0f0;
    font-size: 1.35rem;
    font-weight: 700;
  }

  .locations-list {
    display: flex;
    flex-direction: column;
    gap: .875rem;
  }

  .location-card {
    background: #f8f9fa;
    border: 2px solid #e9ecef;
    border-left: 4px solid transparent;
    border-radius: 10px;
    transition: transform .2s, border-color .2s, box-shadow .2s;
    overflow: hidden;
    contain: layout style paint;
  }

  .card-content {
    padding: 1rem;
    cursor: pointer;
    width: 100%;
    background: none;
    border: none;
    text-align: left;
    transition: background-color .2s;
  }

  .card-content:hover {
    background-color: rgba(197,155,109,.05);
  }

  .card-content:focus-visible {
    outline: 2px solid #C59B6D;
    outline-offset: -2px;
  }

  .card-header {
    display: flex;
    align-items: center;
    gap: .625rem;
    margin-bottom: .5rem;
  }

  .location-icon {
    color: #1B396A;
    flex-shrink: 0;
    transition: color .2s;
  }

  .location-card.active .location-icon {
    color: #C59B6D;
  }

  .location-card:hover {
    border-color: #d0d4d9;
    transform: translateX(2px);
  }

  .location-card.active {
    background: #fff;
    border-color: #C59B6D;
    box-shadow: 0 4px 16px rgba(197,155,109,.2);
    transform: translateX(4px);
  }

  .location-card h3 {
    margin: 0;
    color: #1B396A;
    font-size: 1.05rem;
    font-weight: 600;
    line-height: 1.3;
  }

  .location-description {
    margin: .25rem 0 0;
    font-size: .875rem;
    color: #6c757d;
    line-height: 1.4;
  }

  .card-actions {
    border-top: 1px solid #e9ecef;
    padding: .625rem 1rem;
    background: #fafbfc;
  }

  .route-btn {
    display: inline-flex;
    align-items: center;
    gap: .4rem;
    font-size: .875rem;
    font-weight: 600;
    color: #1B396A;
    text-decoration: none;
    transition: color .2s;
    padding: .25rem 0;
  }

  .route-btn:hover,
  .route-btn:focus-visible {
    color: #C59B6D;
    text-decoration: underline;
  }

  .map-container {
    background: #fff;
    border-radius: 12px;
    overflow: hidden;
    box-shadow: 0 4px 20px rgba(0,0,0,.1);
    position: sticky;
    top: 20px;
    display: flex;
    flex-direction: column;
    height: 600px;
    contain: layout style paint;
  }

  .map-controls {
    padding: 1rem;
    background: #f8f9fa;
    border-bottom: 1px solid #e9ecef;
    display: flex;
    gap: 1rem;
    justify-content: center;
    flex-shrink: 0;
  }

  .mode-btn {
    padding: .625rem 1.5rem;
    border: 2px solid #1B396A;
    background: #fff;
    color: #1B396A;
    border-radius: 24px;
    cursor: pointer;
    font-weight: 600;
    font-size: .9rem;
    transition: all .2s;
    display: flex;
    align-items: center;
    gap: .5rem;
  }

  .mode-btn:hover {
    background: #1B396A;
    color: #fff;
    transform: translateY(-1px);
  }

  .mode-btn.active {
    background: #1B396A;
    color: #fff;
    box-shadow: 0 2px 8px rgba(27,57,106,.3);
  }

  .image-wrapper {
    flex: 1;
    position: relative;
    overflow: hidden;
    background: #f0f2f5;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .map-image {
    width: 100%;
    height: 100%;
    object-fit: contain;
    display: block;
    transition: opacity .25s;
  }

  .locations-sidebar::-webkit-scrollbar {
    width: 6px;
  }
  .locations-sidebar::-webkit-scrollbar-track {
    background: #f1f1f1;
  }
  .locations-sidebar::-webkit-scrollbar-thumb {
    background: #cbd0d6;
    border-radius: 3px;
  }

  @media (max-width: 1024px) {
    .layout-grid {
      grid-template-columns: 1fr;
      gap: 1.5rem;
    }
    .locations-sidebar,
    .map-container {
      position: static;
    }
    .locations-sidebar {
      max-height: 450px;
    }
    .map-container {
      height: 500px;
    }
  }

  @media (max-width: 640px) {
    .page-hero {
      padding: 2rem 0;
    }
    .map-section {
      padding: 2rem 0;
    }
    .container {
      padding: 0 1rem;
    }
    .locations-sidebar {
      padding: 1rem;
      max-height: 400px;
    }
    .map-container {
      height: 400px;
    }
    .map-controls {
      padding: .75rem;
      gap: .75rem;
    }
    .mode-btn {
      padding: .5rem 1rem;
      font-size: .85rem;
    }
  }

  @media (prefers-reduced-motion: reduce) {
    *,
    *::before,
    *::after {
      animation-duration: 0.01ms !important;
      animation-iteration-count: 1 !important;
      transition-duration: 0.01ms !important;
    }
  }
</style>

<script>
  (function() {
    'use strict';
    
    let mode = 'satelital';
    let activeCard = null;
    let img = null;
    const imgCache = new Map();

    function init() {
      const cards = document.querySelectorAll('.location-card');
      img = document.getElementById('main-map-image');
      
      if (!img || !cards.length) return;

      activeCard = document.querySelector('.location-card.active');

      const sidebar = document.querySelector('.locations-sidebar');
      if (sidebar) {
        sidebar.addEventListener('click', handleCardClick);
      }

      const controls = document.querySelector('.map-controls');
      if (controls) {
        controls.addEventListener('click', handleModeClick);
      }

      requestIdleCallback(() => preloadImages(cards));

      cards.forEach((card, i) => {
        const btn = card.querySelector('.card-content');
        if (btn) {
          btn.addEventListener('keydown', (e) => handleKeyNav(e, i, cards));
        }
      });
    }

    function handleCardClick(e) {
      const btn = e.target.closest('.card-content');
      if (!btn) return;
      
      const card = btn.closest('.location-card');
      if (!card || card === activeCard) return;

      selectCard(card, btn);
    }

    function handleModeClick(e) {
      const btn = e.target.closest('.mode-btn');
      if (!btn) return;

      const newMode = btn.dataset.mode;
      if (newMode === mode) return;

      mode = newMode;
      updateModeButtons();
      updateImg();
    }

    function selectCard(card, btn) {
      document.querySelectorAll('.location-card').forEach(c => {
        c.classList.remove('active');
        const b = c.querySelector('.card-content');
        if (b) b.setAttribute('aria-pressed', 'false');
      });

      card.classList.add('active');
      btn.setAttribute('aria-pressed', 'true');
      activeCard = card;

      updateImg();
    }

    function updateModeButtons() {
      document.querySelectorAll('.mode-btn').forEach(btn => {
        const isActive = btn.dataset.mode === mode;
        btn.classList.toggle('active', isActive);
        btn.setAttribute('aria-pressed', String(isActive));
      });
    }

    function updateImg() {
      if (!activeCard || !img) return;

      const src = activeCard.getAttribute(`data-${mode}`);
      if (!src || img.src === src) return;

      img.style.opacity = '0.5';

      if (imgCache.has(src)) {
        img.src = src;
        img.style.opacity = '1';
        updateAlt();
        return;
      }

      const tempImg = new Image();
      tempImg.onload = () => {
        imgCache.set(src, true);
        img.src = src;
        img.style.opacity = '1';
        updateAlt();
      };
      tempImg.src = src;
    }

    function updateAlt() {
      const name = activeCard?.querySelector('h3')?.textContent || 'Ubicación';
      img.alt = `${mode === 'mapa' ? 'Mapa' : 'Vista satelital'} de ${name}`;
    }

    function preloadImages(cards) {
      cards.forEach(card => {
        ['mapa', 'satelital'].forEach(m => {
          const src = card.getAttribute(`data-${m}`);
          if (src && !imgCache.has(src)) {
            const i = new Image();
            i.onload = () => imgCache.set(src, true);
            i.src = src;
          }
        });
      });
    }

    function handleKeyNav(e, idx, cards) {
      if (e.key !== 'ArrowDown' && e.key !== 'ArrowUp') return;
      
      e.preventDefault();
      const nextIdx = e.key === 'ArrowDown' 
        ? Math.min(idx + 1, cards.length - 1)
        : Math.max(idx - 1, 0);
      
      const nextBtn = cards[nextIdx]?.querySelector('.card-content');
      if (nextBtn) nextBtn.focus();
    }

    if ('requestIdleCallback' in window) {
      requestIdleCallback(init);
    } else {
      setTimeout(init, 1);
    }

    document.addEventListener('astro:page-load', init);
  })();
</script>